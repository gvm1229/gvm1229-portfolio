---
/**
 * Resume 페이지 - 네이티브 HTML 이력서 (3가지 레이아웃)
 * PUBLIC_JOB_FIELD에 따라 경력(work)·프로젝트(projects)를 필터링해 노출
 */
import BaseLayout from "@/layouts/BaseLayout.astro";
import ResumeView from "@/components/resume/ResumeView";
import ResumeClassic from "@/components/resume/ResumeClassic.astro";
import ResumeModern from "@/components/resume/ResumeModern.astro";
import ResumeMinimal from "@/components/resume/ResumeMinimal.astro";
import resumeDataRaw from "@/data/resume.json";
import type { Resume } from "@/types/resume";
import { serverClient } from "@/lib/supabase";

// site_config에서 job_field 읽기 (없으면 env → 기본값 "game")
let jobField = import.meta.env.PUBLIC_JOB_FIELD ?? "game";
if (serverClient) {
    const { data: cfg } = await serverClient
        .from("site_config")
        .select("value")
        .eq("key", "job_field")
        .single();
    if (cfg?.value) {
        const raw = cfg.value;
        const parsed =
            typeof raw === "string" && raw.startsWith('"')
                ? JSON.parse(raw)
                : raw;
        if (parsed) jobField = parsed;
    }
}

function filterByJobField<T extends { jobField?: string | string[] }>(
    items: T[] = []
): T[] {
    return items.filter((item) => {
        const jf = item.jobField;
        if (jf == null) return true;
        if (Array.isArray(jf)) return jf.includes(jobField);
        return jf === jobField;
    });
}

function sortByDateDesc<T extends { startDate?: string }>(items: T[]): T[] {
    return [...items].sort((a, b) =>
        (b.startDate ?? "").localeCompare(a.startDate ?? "")
    );
}

const resumeData: Resume = {
    ...resumeDataRaw,
    work: sortByDateDesc(
        filterByJobField(resumeDataRaw.work) ?? []
    ) as Resume["work"],
    projects: sortByDateDesc(
        filterByJobField(resumeDataRaw.projects) ?? []
    ) as Resume["projects"],
};

const title = resumeData.basics?.name
    ? `${resumeData.basics.name} - Resume | FoliumOnline`
    : "Resume - FoliumOnline";
const description = resumeData.basics?.summary ?? "이력서";
---

<BaseLayout title={title} description={description}>
    <div class="resume-page-wrapper">
        <ResumeView client:load resume={resumeData} />
        <div class="resume-layouts-container">
            <div id="resume-classic-container" class="resume-layout hidden">
                <ResumeClassic resume={resumeData} />
            </div>
            <div id="resume-modern-container" class="resume-layout hidden">
                <ResumeModern resume={resumeData} />
            </div>
            <div id="resume-minimal-container" class="resume-layout hidden">
                <ResumeMinimal resume={resumeData} />
            </div>
        </div>
    </div>
</BaseLayout>
