---
/**
 * 포트폴리오 프로젝트 상세 페이지
 * /portfolio/[slug] - 데이터 소스: src/content/portfolio/*.mdoc (Markdoc)
 */
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection, getEntry, render } from "astro:content";
import type { PortfolioProject } from "@/types/portfolio";

export async function getStaticPaths() {
    const jobField = import.meta.env.PUBLIC_JOB_FIELD ?? "game";
    const entries = await getCollection("portfolio");
    const publicEntries = entries.filter((entry) => {
        const d = entry.data as {
            public?: boolean;
            jobField?: string | string[];
        };
        if (d.public !== true) return false;
        const jf = d.jobField;
        if (jf == null) return true;
        if (Array.isArray(jf)) return jf.includes(jobField);
        return jf === jobField;
    });
    return publicEntries.map((entry) => ({
        params: { slug: entry.id.replace(/\.mdoc$/, "") || entry.id },
        props: {},
    }));
}

const slug = Astro.params.slug;
if (!slug) {
    return Astro.redirect("/portfolio");
}
const entryId = slug.replace(/\.mdoc$/, "");
const entry = await getEntry("portfolio", entryId);
if (!entry) {
    return Astro.redirect("/portfolio");
}

const { Content } = await render(entry);
const d = entry.data as Omit<PortfolioProject, "slug"> & {
    jobField?: string | string[];
};
const project: PortfolioProject = {
    slug: entry.id,
    title: d.title,
    description: d.description,
    startDate: d.startDate,
    endDate: d.endDate,
    goal: d.goal,
    role: d.role,
    teamSize: d.teamSize,
    accomplishments: d.accomplishments ?? [],
    keywords: d.keywords ?? [],
    github: d.github ?? "",
    public: d.public,
    jobField: d.jobField,
    thumbnail: d.thumbnail,
    badges: d.badges,
};
---

<BaseLayout
    title={`${project.title} - Portfolio | FoliumOnline`}
    description={project.description}
>
    <article class="max-w-3xl mx-auto">
        <a
            href="/portfolio"
            class="inline-flex items-center gap-1 text-sm text-(--color-muted) hover:text-(--color-foreground) mb-6"
        >
            ← Portfolio 목록
        </a>

        {
            project.thumbnail ? (
                <div class="rounded-xl overflow-hidden border border-(--color-border) mb-6 aspect-video bg-(--color-surface-subtle)">
                    <img
                        src={project.thumbnail}
                        alt=""
                        width={640}
                        height={360}
                        loading="eager"
                        decoding="async"
                        class="w-full h-full object-cover"
                    />
                </div>
            ) : null
        }

        <header class="mb-6">
            <h1 class="text-3xl font-bold text-(--color-foreground) mb-2">
                {project.title}
            </h1>
            {
                project.keywords.length > 0 ? (
                    <div class="flex flex-wrap gap-2">
                        {project.keywords.map((k) => (
                            <span class="px-2 py-1 text-xs rounded-full bg-(--color-tag-bg) text-(--color-tag-fg)">
                                {k}
                            </span>
                        ))}
                    </div>
                ) : null
            }
        </header>

        <p class="text-(--color-foreground) leading-relaxed mb-8">
            {project.description}
        </p>

        <dl
            class="grid grid-cols-1 gap-4 text-sm mb-8 p-6 rounded-xl border border-(--color-border) bg-(--color-surface-subtle) tablet:grid-cols-2"
        >
            <div>
                <dt class="text-(--color-muted) font-medium">기간</dt>
                <dd class="text-(--color-foreground)">
                    {project.startDate} ~ {project.endDate}
                </dd>
            </div>
            <div>
                <dt class="text-(--color-muted) font-medium">역할</dt>
                <dd class="text-(--color-foreground)">{project.role}</dd>
            </div>
            <div>
                <dt class="text-(--color-muted) font-medium">참여 인원</dt>
                <dd class="text-(--color-foreground)">{project.teamSize}명</dd>
            </div>
            <div>
                <dt class="text-(--color-muted) font-medium">목표</dt>
                <dd class="text-(--color-foreground)">{project.goal}</dd>
            </div>
        </dl>

        {
            project.accomplishments.length > 0 ? (
                <section class="mb-8">
                    <h2 class="text-lg font-semibold text-(--color-foreground) mb-3">
                        성과
                    </h2>
                    <ul class="list-disc list-inside space-y-2 text-(--color-foreground)">
                        {project.accomplishments.map((a) => (
                            <li>{a}</li>
                        ))}
                    </ul>
                </section>
            ) : null
        }

        {
            project.badges?.length ? (
                <section class="mb-8">
                    <h2 class="text-lg font-semibold text-(--color-foreground) mb-3">
                        수상·출시
                    </h2>
                    <ul class="space-y-2 text-(--color-foreground)">
                        {project.badges.map((b) => (
                            <li class="flex items-center gap-2">
                                <span class="text-(--color-muted)" aria-hidden>
                                    ◆
                                </span>
                                {b.text}
                            </li>
                        ))}
                    </ul>
                </section>
            ) : null
        }

        {
            project.github ? (
                <p>
                    <a
                        href={project.github}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-(--color-link) hover:underline font-medium"
                    >
                        GitHub 저장소 →
                    </a>
                </p>
            ) : null
        }

        <div
            class="portfolio-markdoc-body mt-10 pt-8 border-t border-(--color-border) prose max-w-none text-(--color-foreground)"
        >
            <Content />
        </div>
    </article>
</BaseLayout>

<script>
    /**
     * Markdoc 본문 내 ```mermaid 코드 블록을 클라이언트에서 Mermaid로 렌더링.
     * portfolio-markdoc-body 내 pre > code.language-mermaid 요소를 찾아 SVG로 치환.
     */
    async function renderMermaidBlocks() {
        const container = document.querySelector(".portfolio-markdoc-body");
        if (!container) return;
        const codeBlocks = container.querySelectorAll(
            "pre > code.language-mermaid"
        );
        if (codeBlocks.length === 0) return;
        const mermaid = (
            await import("https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs")
        ).default;
        mermaid.initialize({ startOnLoad: false, theme: "neutral" });
        for (const code of codeBlocks) {
            const pre = code.closest("pre");
            if (!pre) continue;
            const chartDefinition = code.textContent?.trim();
            if (!chartDefinition) continue;
            const id = "mermaid-" + Math.random().toString(36).slice(2, 9);
            const wrap = document.createElement("div");
            wrap.className = "mermaid-rendered my-6 flex justify-center";
            wrap.setAttribute("data-mermaid-id", id);
            try {
                const { svg } = await mermaid.render(id, chartDefinition);
                wrap.innerHTML = svg;
            } catch (err) {
                console.warn("[portfolio slug] Mermaid render failed:", err);
                wrap.innerHTML = `<pre class="text-sm text-(--color-muted) overflow-auto p-4 rounded border border-(--color-border)">${chartDefinition}</pre>`;
            }
            pre.replaceWith(wrap);
        }
    }
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", renderMermaidBlocks);
    } else {
        renderMermaidBlocks();
    }
</script>

<style>
    /* Markdoc 본문을 전경색으로 표시. Content가 렌더한 자식은 스코프 밖이므로 :global() 사용. prose가 제목/목록에 고정 색을 넣어 모드별로 어긋나므로 !important로 통일 */
    :global(.portfolio-markdoc-body.prose),
    :global(.portfolio-markdoc-body.prose p),
    :global(.portfolio-markdoc-body.prose strong) {
        color: var(--color-foreground);
    }
    :global(.portfolio-markdoc-body.prose h1),
    :global(.portfolio-markdoc-body.prose h2),
    :global(.portfolio-markdoc-body.prose h3),
    :global(.portfolio-markdoc-body.prose h4) {
        color: var(--color-foreground) !important;
    }
    :global(.portfolio-markdoc-body.prose ul),
    :global(.portfolio-markdoc-body.prose ol),
    :global(.portfolio-markdoc-body.prose li) {
        color: var(--color-foreground) !important;
    }
    :global(.portfolio-markdoc-body.prose li)::marker {
        color: var(--color-foreground) !important;
    }
    :global(.portfolio-markdoc-body.prose hr) {
        border-color: var(--color-border);
    }
</style>
