---
/**
 * 포트폴리오 프로젝트 상세 페이지
 * 빌드 타임에 Supabase portfolio_items 테이블에서 fetch한다.
 * 마크다운 본문은 Markdoc + Shiki 파이프라인으로 HTML 변환한다.
 */
import BaseLayout from "@/layouts/BaseLayout.astro";
import { serverClient } from "@/lib/supabase";
import type { PortfolioProject } from "@/types/portfolio";
import { renderMarkdown } from "@/lib/markdown";
import { extractTocFromHtml } from "@/lib/toc";
import TableOfContents from "@/components/TableOfContents";

export async function getStaticPaths() {
    if (!serverClient) return [];
    const { data: items } = await serverClient
        .from("portfolio_items")
        .select("slug")
        .eq("published", true);
    if (!items) return [];
    return items.map((i) => ({ params: { slug: i.slug } }));
}

const { slug } = Astro.params;
if (!slug || !serverClient) return Astro.redirect("/portfolio");

const { data: item } = await serverClient
    .from("portfolio_items")
    .select("*")
    .eq("slug", slug)
    .single();

if (!item) return Astro.redirect("/portfolio");

const d = item.data ?? {};
const project: PortfolioProject = {
    slug: item.slug,
    title: item.title,
    description: item.description ?? "",
    startDate: d.startDate,
    endDate: d.endDate,
    goal: d.goal,
    role: d.role,
    teamSize: d.teamSize,
    accomplishments: d.accomplishments ?? [],
    keywords: item.tags ?? [],
    github: d.github ?? "",
    public: true,
    jobField: d.jobField,
    thumbnail: item.thumbnail,
    badges: d.badges,
};

// 마크다운 → HTML 변환 (Markdoc + Shiki, 빌드 타임)
const contentHtml = await renderMarkdown(item.content ?? "");
const tocEntries = extractTocFromHtml(contentHtml);
const pageTitle =
    item.meta_title || `${project.title} - Portfolio | FoliumOnline`;
const pageDesc = item.meta_description || project.description || "";
const pageImage = item.og_image || project.thumbnail || "";
---

<BaseLayout title={pageTitle} description={pageDesc} image={pageImage}>
    <div class="mx-auto flex max-w-5xl gap-12">
        <article class="max-w-3xl min-w-0 flex-1">
            <a
                href="/portfolio"
                class="mb-6 inline-flex items-center gap-1 text-sm text-(--color-muted) hover:text-(--color-foreground)"
            >
                ← Portfolio 목록
            </a>

            {
                project.thumbnail ? (
                    <div class="mb-6 aspect-video overflow-hidden rounded-xl border border-(--color-border) bg-(--color-surface-subtle)">
                        <img
                            src={project.thumbnail}
                            alt=""
                            width={640}
                            height={360}
                            loading="eager"
                            decoding="async"
                            class="h-full w-full object-cover"
                        />
                    </div>
                ) : null
            }

            <header class="mb-6">
                <h1 class="mb-2 text-3xl font-bold text-(--color-foreground)">
                    {project.title}
                </h1>
                {
                    project.keywords.length > 0 ? (
                        <div class="flex flex-wrap gap-2">
                            {project.keywords.map((k) => (
                                <span class="rounded-full bg-(--color-tag-bg) px-2 py-1 text-xs text-(--color-tag-fg)">
                                    {k}
                                </span>
                            ))}
                        </div>
                    ) : null
                }
            </header>

            <p class="mb-8 leading-relaxed text-(--color-foreground)">
                {project.description}
            </p>

            <dl
                class="tablet:grid-cols-2 mb-8 grid grid-cols-1 gap-4 rounded-xl border border-(--color-border) bg-(--color-surface-subtle) p-6 text-sm"
            >
                <div>
                    <dt class="font-medium text-(--color-muted)">기간</dt>
                    <dd class="text-(--color-foreground)">
                        {project.startDate} ~ {project.endDate}
                    </dd>
                </div>
                <div>
                    <dt class="font-medium text-(--color-muted)">역할</dt>
                    <dd class="text-(--color-foreground)">{project.role}</dd>
                </div>
                <div>
                    <dt class="font-medium text-(--color-muted)">참여 인원</dt>
                    <dd class="text-(--color-foreground)">
                        {project.teamSize}명
                    </dd>
                </div>
                <div>
                    <dt class="font-medium text-(--color-muted)">목표</dt>
                    <dd class="text-(--color-foreground)">{project.goal}</dd>
                </div>
            </dl>

            {
                project.accomplishments.length > 0 ? (
                    <section class="mb-8">
                        <h2 class="mb-3 text-lg font-semibold text-(--color-foreground)">
                            성과
                        </h2>
                        <ul class="list-inside list-disc space-y-2 text-(--color-foreground)">
                            {project.accomplishments.map((a) => (
                                <li>{a}</li>
                            ))}
                        </ul>
                    </section>
                ) : null
            }

            {
                project.badges?.length ? (
                    <section class="mb-8">
                        <h2 class="mb-3 text-lg font-semibold text-(--color-foreground)">
                            수상·출시
                        </h2>
                        <ul class="space-y-2 text-(--color-foreground)">
                            {project.badges.map((b) => (
                                <li class="flex items-center gap-2">
                                    <span
                                        class="text-(--color-muted)"
                                        aria-hidden
                                    >
                                        ◆
                                    </span>
                                    {b.text}
                                </li>
                            ))}
                        </ul>
                    </section>
                ) : null
            }

            {
                project.github ? (
                    <p>
                        <a
                            href={project.github}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="font-medium text-(--color-link) hover:underline"
                        >
                            GitHub 저장소 →
                        </a>
                    </p>
                ) : null
            }

            <div
                class="portfolio-markdoc-body prose mt-10 max-w-none border-t border-(--color-border) pt-8 text-(--color-foreground)"
                data-content="true"
                set:html={contentHtml}
            />
        </article>
        <TableOfContents
            client:visible
            entries={tocEntries}
            contentSelector=".portfolio-markdoc-body"
        />
    </div>
</BaseLayout>

<script>
    import {
        renderMermaidBlocks,
        rerenderMermaidOnThemeChange,
    } from "@/lib/mermaid-render";

    const run = () =>
        renderMermaidBlocks(".portfolio-markdoc-body", "portfolio slug");
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", run);
    } else {
        run();
    }
    window.addEventListener("themechange", () =>
        rerenderMermaidOnThemeChange("portfolio slug")
    );
</script>

<style>
    /* 전경색 통일. Content가 렌더한 자식은 스코프 밖이므로 :global() 사용 */
    :global(.portfolio-markdoc-body.prose),
    :global(.portfolio-markdoc-body.prose p),
    :global(.portfolio-markdoc-body.prose strong) {
        color: var(--color-foreground);
    }
    :global(.portfolio-markdoc-body.prose h1),
    :global(.portfolio-markdoc-body.prose h2),
    :global(.portfolio-markdoc-body.prose h3),
    :global(.portfolio-markdoc-body.prose h4) {
        color: var(--color-foreground) !important;
    }
    :global(.portfolio-markdoc-body.prose ul),
    :global(.portfolio-markdoc-body.prose ol),
    :global(.portfolio-markdoc-body.prose li) {
        color: var(--color-foreground) !important;
    }
    :global(.portfolio-markdoc-body.prose li)::marker {
        color: var(--color-foreground) !important;
    }
    :global(.portfolio-markdoc-body.prose hr) {
        border-color: var(--color-border);
    }
</style>
