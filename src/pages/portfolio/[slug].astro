---
/**
 * 포트폴리오 프로젝트 상세 페이지
 * 빌드 타임에 Supabase portfolio_items 테이블에서 fetch한다.
 * 마크다운 본문은 unified + Shiki 파이프라인으로 HTML 변환한다.
 */
import BaseLayout from "@/layouts/BaseLayout.astro";
import { serverClient } from "@/lib/supabase";
import type { PortfolioProject } from "@/types/portfolio";
import { renderMarkdown } from "@/lib/markdown";

export async function getStaticPaths() {
    if (!serverClient) return [];
    const { data: items } = await serverClient
        .from("portfolio_items")
        .select("slug")
        .eq("published", true);
    if (!items) return [];
    return items.map((i) => ({ params: { slug: i.slug } }));
}

const { slug } = Astro.params;
if (!slug || !serverClient) return Astro.redirect("/portfolio");

const { data: item } = await serverClient
    .from("portfolio_items")
    .select("*")
    .eq("slug", slug)
    .single();

if (!item) return Astro.redirect("/portfolio");

const d = item.data ?? {};
const project: PortfolioProject = {
    slug: item.slug,
    title: item.title,
    description: item.description ?? "",
    startDate: d.startDate,
    endDate: d.endDate,
    goal: d.goal,
    role: d.role,
    teamSize: d.teamSize,
    accomplishments: d.accomplishments ?? [],
    keywords: item.tags ?? [],
    github: d.github ?? "",
    public: true,
    jobField: d.jobField,
    thumbnail: item.thumbnail,
    badges: d.badges,
};

// 마크다운 → HTML 변환 (unified + Shiki, 빌드 타임)
const contentHtml = await renderMarkdown(item.content ?? "");
---

<BaseLayout
    title={`${project.title} - Portfolio | FoliumOnline`}
    description={project.description}
>
    <article class="max-w-3xl mx-auto">
        <a
            href="/portfolio"
            class="inline-flex items-center gap-1 text-sm text-(--color-muted) hover:text-(--color-foreground) mb-6"
        >
            ← Portfolio 목록
        </a>

        {
            project.thumbnail ? (
                <div class="rounded-xl overflow-hidden border border-(--color-border) mb-6 aspect-video bg-(--color-surface-subtle)">
                    <img
                        src={project.thumbnail}
                        alt=""
                        width={640}
                        height={360}
                        loading="eager"
                        decoding="async"
                        class="w-full h-full object-cover"
                    />
                </div>
            ) : null
        }

        <header class="mb-6">
            <h1 class="text-3xl font-bold text-(--color-foreground) mb-2">
                {project.title}
            </h1>
            {
                project.keywords.length > 0 ? (
                    <div class="flex flex-wrap gap-2">
                        {project.keywords.map((k) => (
                            <span class="px-2 py-1 text-xs rounded-full bg-(--color-tag-bg) text-(--color-tag-fg)">
                                {k}
                            </span>
                        ))}
                    </div>
                ) : null
            }
        </header>

        <p class="text-(--color-foreground) leading-relaxed mb-8">
            {project.description}
        </p>

        <dl
            class="grid grid-cols-1 gap-4 text-sm mb-8 p-6 rounded-xl border border-(--color-border) bg-(--color-surface-subtle) tablet:grid-cols-2"
        >
            <div>
                <dt class="text-(--color-muted) font-medium">기간</dt>
                <dd class="text-(--color-foreground)">
                    {project.startDate} ~ {project.endDate}
                </dd>
            </div>
            <div>
                <dt class="text-(--color-muted) font-medium">역할</dt>
                <dd class="text-(--color-foreground)">{project.role}</dd>
            </div>
            <div>
                <dt class="text-(--color-muted) font-medium">참여 인원</dt>
                <dd class="text-(--color-foreground)">{project.teamSize}명</dd>
            </div>
            <div>
                <dt class="text-(--color-muted) font-medium">목표</dt>
                <dd class="text-(--color-foreground)">{project.goal}</dd>
            </div>
        </dl>

        {
            project.accomplishments.length > 0 ? (
                <section class="mb-8">
                    <h2 class="text-lg font-semibold text-(--color-foreground) mb-3">
                        성과
                    </h2>
                    <ul class="list-disc list-inside space-y-2 text-(--color-foreground)">
                        {project.accomplishments.map((a) => (
                            <li>{a}</li>
                        ))}
                    </ul>
                </section>
            ) : null
        }

        {
            project.badges?.length ? (
                <section class="mb-8">
                    <h2 class="text-lg font-semibold text-(--color-foreground) mb-3">
                        수상·출시
                    </h2>
                    <ul class="space-y-2 text-(--color-foreground)">
                        {project.badges.map((b) => (
                            <li class="flex items-center gap-2">
                                <span class="text-(--color-muted)" aria-hidden>
                                    ◆
                                </span>
                                {b.text}
                            </li>
                        ))}
                    </ul>
                </section>
            ) : null
        }

        {
            project.github ? (
                <p>
                    <a
                        href={project.github}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-(--color-link) hover:underline font-medium"
                    >
                        GitHub 저장소 →
                    </a>
                </p>
            ) : null
        }

        <div
            class="portfolio-markdoc-body mt-10 pt-8 border-t border-(--color-border) prose max-w-none text-(--color-foreground)"
            set:html={contentHtml}
        />
    </article>
</BaseLayout>

<script>
    import { getMermaidConfig } from "@/lib/mermaid-themes";
    /**
     * 본문 내 ```mermaid 코드 블록을 클라이언트에서 Mermaid로 렌더링.
     * marked 출력: pre > code.language-mermaid
     */
    async function renderMermaidBlocks() {
        const container = document.querySelector(".portfolio-markdoc-body");
        if (!container) return;
        const blocks = Array.from(
            container.querySelectorAll("pre > code.language-mermaid")
        )
            .map((code) => code.closest("pre"))
            .filter(Boolean);
        if (blocks.length === 0) return;
        const mermaid = (
            await import("https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs")
        ).default;
        const root = document.documentElement;
        const isDark = root.classList.contains("dark");
        const scheme = root.getAttribute("data-color-scheme");
        const { theme, themeVariables } = getMermaidConfig(scheme, isDark);
        mermaid.initialize({
            startOnLoad: false,
            theme,
            themeVariables,
        } as { startOnLoad?: boolean; theme?: string });
        for (const pre of blocks) {
            const chartDefinition = pre?.textContent?.trim();
            if (!chartDefinition) continue;
            const id = "mermaid-" + Math.random().toString(36).slice(2, 9);
            const wrap = document.createElement("div");
            wrap.className = "mermaid-rendered my-6 flex justify-center";
            wrap.setAttribute("data-mermaid-id", id);
            wrap.setAttribute("data-mermaid-definition", chartDefinition);
            try {
                const { svg } = await mermaid.render(id, chartDefinition);
                wrap.innerHTML = svg;
            } catch (err) {
                console.warn("[portfolio slug] Mermaid render failed:", err);
                wrap.innerHTML = `<pre class="text-sm text-(--color-muted) overflow-auto p-4 rounded border border-(--color-border)">${chartDefinition}</pre>`;
            }
            pre?.replaceWith(wrap);
        }
    }
    async function rerenderMermaidOnThemeChange() {
        const rendered = document.querySelectorAll(
            ".mermaid-rendered[data-mermaid-definition]"
        );
        if (rendered.length === 0) return;
        const mermaid = (
            await import("https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs")
        ).default;
        const root = document.documentElement;
        const isDark = root.classList.contains("dark");
        const scheme = root.getAttribute("data-color-scheme");
        const { theme, themeVariables } = getMermaidConfig(scheme, isDark);
        mermaid.initialize({
            startOnLoad: false,
            theme,
            themeVariables,
        } as { startOnLoad?: boolean; theme?: string });
        for (const wrap of rendered) {
            const def = wrap.getAttribute("data-mermaid-definition");
            if (!def) continue;
            const id = "mermaid-" + Math.random().toString(36).slice(2, 9);
            try {
                const { svg } = await mermaid.render(id, def);
                wrap.innerHTML = svg;
            } catch (err) {
                console.warn("[portfolio slug] Mermaid re-render failed:", err);
            }
        }
    }
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", renderMermaidBlocks);
    } else {
        renderMermaidBlocks();
    }
    window.addEventListener("themechange", rerenderMermaidOnThemeChange);
</script>

<style>
    /* 전경색 통일. Content가 렌더한 자식은 스코프 밖이므로 :global() 사용 */
    :global(.portfolio-markdoc-body.prose),
    :global(.portfolio-markdoc-body.prose p),
    :global(.portfolio-markdoc-body.prose strong) {
        color: var(--color-foreground);
    }
    :global(.portfolio-markdoc-body.prose h1),
    :global(.portfolio-markdoc-body.prose h2),
    :global(.portfolio-markdoc-body.prose h3),
    :global(.portfolio-markdoc-body.prose h4) {
        color: var(--color-foreground) !important;
    }
    :global(.portfolio-markdoc-body.prose ul),
    :global(.portfolio-markdoc-body.prose ol),
    :global(.portfolio-markdoc-body.prose li) {
        color: var(--color-foreground) !important;
    }
    :global(.portfolio-markdoc-body.prose li)::marker {
        color: var(--color-foreground) !important;
    }
    :global(.portfolio-markdoc-body.prose hr) {
        border-color: var(--color-border);
    }
</style>
