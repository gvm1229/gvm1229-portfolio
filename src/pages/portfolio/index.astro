---
/**
 * Portfolio 페이지 - 프로젝트 목록
 * 빌드 타임에 Supabase portfolio_items 테이블에서 fetch한다.
 * job_field 필터는 site_config 테이블에서 읽고, env 폴백을 사용한다.
 */
import BaseLayout from "@/layouts/BaseLayout.astro";
import PortfolioView from "@/components/PortfolioView";
import { serverClient } from "@/lib/supabase";
import type { PortfolioProject } from "@/types/portfolio";

// site_config에서 job_field 읽기 (없으면 env → 기본값 "game")
let jobField = import.meta.env.PUBLIC_JOB_FIELD ?? "game";
if (serverClient) {
    const { data: cfg } = await serverClient
        .from("site_config")
        .select("value")
        .eq("key", "job_field")
        .single();
    if (cfg?.value) {
        const raw = cfg.value;
        jobField =
            typeof raw === "string" && raw.startsWith('"')
                ? JSON.parse(raw)
                : raw;
    }
}

function matchesJobField(jf: string | string[] | undefined): boolean {
    if (jf == null) return true;
    if (Array.isArray(jf)) return jf.includes(jobField);
    return jf === jobField;
}

let publicProjects: PortfolioProject[] = [];

if (serverClient) {
    const { data: items } = await serverClient
        .from("portfolio_items")
        .select("slug, title, description, tags, thumbnail, data, published")
        .eq("published", true)
        .order("order_idx", { ascending: true });

    if (items) {
        publicProjects = items
            .map((item): PortfolioProject => {
                const d = item.data ?? {};
                return {
                    slug: item.slug,
                    title: item.title,
                    description: item.description ?? "",
                    startDate: d.startDate,
                    endDate: d.endDate,
                    goal: d.goal,
                    role: d.role,
                    teamSize: d.teamSize,
                    accomplishments: d.accomplishments ?? [],
                    keywords: item.tags ?? [],
                    github: d.github ?? "",
                    public: true,
                    jobField: d.jobField,
                    thumbnail: item.thumbnail,
                    badges: d.badges,
                };
            })
            .filter((p) => matchesJobField(p.jobField))
            .sort((a, b) =>
                (b.startDate ?? "").localeCompare(a.startDate ?? "")
            );
    }
}
---

<BaseLayout title="Portfolio - FoliumOnline" description="프로젝트 포트폴리오">
    <div class="max-w-4xl">
        <h1 class="mb-2 text-3xl font-bold text-(--color-foreground)">
            Portfolio
        </h1>
        <p class="mb-8 text-(--color-muted)">
            프로젝트 목록입니다. List는 상세 정보를 한 화면에, Block은 카드
            그리드로 보기입니다.
        </p>

        <PortfolioView client:load projects={publicProjects} />
    </div>
</BaseLayout>
