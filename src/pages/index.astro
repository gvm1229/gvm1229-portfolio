---
/**
 * 랜딩 페이지 - 단일 스크롤 구성
 * Hero → About 미리보기 → Portfolio (featured) → Blog (최신 5개)
 * 빌드 타임에 Supabase serverClient로 데이터를 fetch한다.
 */
import BaseLayout from "@/layouts/BaseLayout.astro";
import { serverClient } from "@/lib/supabase";
import {
    getFirstImageFromContent,
    getFirstThreeSentences,
    formatPubDateKST,
} from "@/lib/blog";

// 포트폴리오 프로젝트 최대 표시 수
const PORTFOLIO_PROJ_MAX_NUM = 4;
// 블로그 포스트 최대 표시 수
const BLOG_POST_MAX_NUM = 5;

// ── About 미리보기 ────────────────────────────────────────────
interface AboutData {
    name?: string;
    description?: string;
    descriptionSub?: string;
}
let about: AboutData = {};
if (serverClient) {
    const { data } = await serverClient
        .from("about_data")
        .select("data")
        .limit(1)
        .single();
    if (data) about = data.data as AboutData;
}

// ── Portfolio featured items ──────────────────────────────────
interface FeaturedItem {
    slug: string;
    title: string;
    description: string | null;
    tags: string[] | null;
    thumbnail: string | null;
}
let featuredItems: FeaturedItem[] = [];
if (serverClient) {
    const { data } = await serverClient
        .from("portfolio_items")
        .select("slug, title, description, tags, thumbnail")
        .eq("published", true)
        .eq("featured", true)
        .order("order_idx", { ascending: true })
        .limit(PORTFOLIO_PROJ_MAX_NUM);
    if (data) featuredItems = data as FeaturedItem[];
}

// ── Blog 최신 5개 ─────────────────────────────────────────────
interface PostPreview {
    slug: string;
    title: string;
    displayDescription: string;
    pubDateFormatted: string;
    pubDateIso: string;
    category: string | null;
    thumbnailUrl: string | null;
}
let latestPosts: PostPreview[] = [];
if (serverClient) {
    const { data } = await serverClient
        .from("posts")
        .select(
            "slug, title, description, pub_date, category, thumbnail, content"
        )
        .eq("published", true)
        .order("pub_date", { ascending: false })
        .limit(BLOG_POST_MAX_NUM);
    if (data) {
        latestPosts = data.map((p) => {
            const body: string = p.content ?? "";
            const firstImage = getFirstImageFromContent(body);
            return {
                slug: p.slug,
                title: p.title,
                displayDescription:
                    p.description?.trim() ?? getFirstThreeSentences(body),
                pubDateFormatted: formatPubDateKST(new Date(p.pub_date)),
                pubDateIso: new Date(p.pub_date).toISOString(),
                category: p.category?.trim() ?? null,
                thumbnailUrl: p.thumbnail || firstImage || null,
            };
        });
    }
}

const heroName = about.name ?? "FoliumOnline";
const heroDesc =
    about.description ?? "포트폴리오와 기술 블로그가 함께하는 공간입니다.";
const isDev = import.meta.env.DEV;
---

<BaseLayout
    title="FoliumOnline - 포트폴리오 & 기술 블로그"
    description={heroDesc}
>
    <!-- ── Hero ──────────────────────────────────────────────── -->
    <section class="max-w-4xl mx-auto text-center py-16 tablet:py-24">
        <p
            class="text-sm font-semibold text-(--color-accent) uppercase tracking-widest mb-4"
        >
            포트폴리오 & 기술 블로그
        </p>
        <h1
            class="text-4xl font-black text-(--color-foreground) mb-4 tablet:text-6xl leading-tight"
        >
            {heroName}
        </h1>
        <p
            class="text-lg text-(--color-muted) max-w-2xl mx-auto leading-relaxed mb-8"
        >
            {heroDesc}
        </p>
        <div class="flex flex-wrap justify-center gap-3">
            <a
                href="/portfolio"
                class="px-6 py-3 rounded-lg bg-(--color-accent) text-(--color-on-accent) font-semibold text-sm hover:opacity-90 transition-opacity"
            >
                Portfolio 보기
            </a>
            <a
                href="/resume"
                class="px-6 py-3 rounded-lg border border-(--color-border) text-(--color-foreground) font-semibold text-sm hover:border-(--color-accent) hover:text-(--color-accent) transition-colors"
            >
                Resume 보기
            </a>
        </div>
    </section>

    <!-- ── About 미리보기 ──────────────────────────────────────── -->
    {
        about.name && (
            <section class="max-w-4xl mx-auto py-12 border-t border-(--color-border)">
                <h2 class="text-2xl font-bold text-(--color-foreground) mb-6">
                    About me
                </h2>
                <div class="flex flex-col gap-4 tablet:flex-row tablet:items-start tablet:gap-8">
                    <div class="flex-1">
                        {about.description && (
                            <p class="text-(--color-foreground) leading-relaxed mb-3">
                                {about.description}
                            </p>
                        )}
                        {about.descriptionSub && (
                            <p class="text-(--color-muted) text-sm leading-relaxed">
                                {about.descriptionSub}
                            </p>
                        )}
                        <a
                            href="/about"
                            class="inline-flex items-center gap-1 mt-4 text-sm font-medium text-(--color-accent) hover:underline"
                        >
                            소개 전체 보기
                            <svg
                                class="w-4 h-4"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9 5l7 7-7 7"
                                />
                            </svg>
                        </a>
                    </div>
                </div>
            </section>
        )
    }

    <!-- ── Portfolio Featured ─────────────────────────────────── -->
    {
        featuredItems.length > 0 && (
            <section class="max-w-4xl mx-auto py-12 border-t border-(--color-border)">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-(--color-foreground)">
                        Portfolio
                    </h2>
                    <a
                        href="/portfolio"
                        class="text-sm font-medium text-(--color-accent) hover:underline inline-flex items-center gap-1"
                    >
                        전체 보기
                        <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 5l7 7-7 7"
                            />
                        </svg>
                    </a>
                </div>
                <div class="grid grid-cols-1 gap-4 tablet:grid-cols-2 tablet:gap-6">
                    {featuredItems.map((item) => (
                        <a
                            href={`/portfolio/${item.slug}`}
                            class="group block rounded-xl border border-(--color-border) bg-(--color-surface-subtle) hover:border-(--color-accent) transition-colors overflow-hidden"
                        >
                            {item.thumbnail && (
                                <div class="aspect-video overflow-hidden bg-(--color-border)">
                                    <img
                                        src={item.thumbnail}
                                        alt=""
                                        width={480}
                                        height={270}
                                        loading="lazy"
                                        class="w-full h-full object-cover transition-transform group-hover:scale-105"
                                    />
                                </div>
                            )}
                            <div class="p-5">
                                <h3 class="font-semibold text-(--color-foreground) mb-2 group-hover:text-(--color-accent) transition-colors">
                                    {item.title}
                                </h3>
                                {item.description && (
                                    <p class="text-sm text-(--color-muted) line-clamp-2 mb-3">
                                        {item.description}
                                    </p>
                                )}
                                {item.tags && item.tags.length > 0 && (
                                    <div class="flex flex-wrap gap-1.5">
                                        {item.tags.slice(0, 4).map((t) => (
                                            <span class="px-2 py-0.5 text-xs rounded-full bg-(--color-tag-bg) text-(--color-tag-fg)">
                                                {t}
                                            </span>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </a>
                    ))}
                </div>
            </section>
        )
    }

    <!-- ── Blog 최신 글 ────────────────────────────────────────── -->
    {
        latestPosts.length > 0 && (
            <section class="max-w-4xl mx-auto py-12 border-t border-(--color-border)">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-(--color-foreground)">
                        Blog
                    </h2>
                    <a
                        href="/blog"
                        class="text-sm font-medium text-(--color-accent) hover:underline inline-flex items-center gap-1"
                    >
                        전체 보기
                        <svg
                            class="w-4 h-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 5l7 7-7 7"
                            />
                        </svg>
                    </a>
                </div>

                {/* 최신 2개 — 큰 카드 블록 */}
                <div class="grid grid-cols-1 gap-4 tablet:grid-cols-2 tablet:gap-6 mb-6">
                    {latestPosts.slice(0, 2).map((post) => (
                        <a
                            href={`/blog/${post.slug}`}
                            class="group block rounded-xl border border-(--color-border) bg-(--color-surface-subtle) hover:border-(--color-accent) transition-colors overflow-hidden"
                        >
                            {post.thumbnailUrl && (
                                <div class="aspect-video overflow-hidden bg-(--color-border)">
                                    <img
                                        src={post.thumbnailUrl}
                                        alt=""
                                        width={480}
                                        height={270}
                                        loading="lazy"
                                        class="w-full h-full object-cover transition-transform group-hover:scale-105"
                                    />
                                </div>
                            )}
                            <div class="p-5">
                                {post.category && (
                                    <p class="text-xs font-semibold text-(--color-accent) uppercase tracking-wider mb-1">
                                        {post.category}
                                    </p>
                                )}
                                <h3 class="font-semibold text-(--color-foreground) mb-2 group-hover:text-(--color-accent) transition-colors line-clamp-2">
                                    {post.title}
                                </h3>
                                <p class="text-sm text-(--color-muted) line-clamp-2 mb-3">
                                    {post.displayDescription}
                                </p>
                                <time
                                    datetime={post.pubDateIso}
                                    class="text-xs text-(--color-muted)"
                                >
                                    {post.pubDateFormatted}
                                </time>
                            </div>
                        </a>
                    ))}
                </div>

                {/* 다음 3개 — 컴팩트 리스트 */}
                {latestPosts.length > 2 && (
                    <ul class="divide-y divide-(--color-border) border border-(--color-border) rounded-xl overflow-hidden">
                        {latestPosts.slice(2).map((post) => (
                            <li>
                                <a
                                    href={`/blog/${post.slug}`}
                                    class="group flex items-start gap-4 px-5 py-4 bg-(--color-surface-subtle) hover:bg-(--color-surface) transition-colors"
                                >
                                    <div class="flex-1 min-w-0">
                                        {post.category && (
                                            <span class="text-xs font-semibold text-(--color-accent) uppercase tracking-wider mr-2">
                                                {post.category}
                                            </span>
                                        )}
                                        <span class="text-sm font-medium text-(--color-foreground) group-hover:text-(--color-accent) transition-colors">
                                            {post.title}
                                        </span>
                                    </div>
                                    <time
                                        datetime={post.pubDateIso}
                                        class="text-xs text-(--color-muted) shrink-0 mt-0.5"
                                    >
                                        {post.pubDateFormatted}
                                    </time>
                                </a>
                            </li>
                        ))}
                    </ul>
                )}
            </section>
        )
    }

    <!-- ── Dev 도구 (dev 환경 전용) ───────────────────────────── -->
    {
        isDev && (
            <section class="max-w-4xl mx-auto mt-4 mb-8 p-4 rounded-xl border border-(--color-border) border-dashed bg-(--color-surface-subtle)">
                <p class="text-xs font-medium text-(--color-muted) mb-3 uppercase tracking-wider">
                    개발 도구
                </p>
                <div class="flex flex-wrap gap-3">
                    <a
                        href="/admin"
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-(--color-border) bg-(--color-surface) text-(--color-foreground) text-sm font-medium hover:opacity-90 transition-opacity"
                    >
                        Admin
                    </a>
                </div>
            </section>
        )
    }
</BaseLayout>
