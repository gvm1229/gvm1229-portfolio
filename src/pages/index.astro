---
/**
 * 랜딩 페이지 - 단일 스크롤 구성
 * Hero → About 미리보기 → Portfolio (featured) → Blog (최신 5개)
 * 빌드 타임에 Supabase serverClient로 데이터를 fetch한다.
 */
import BaseLayout from "@/layouts/BaseLayout.astro";
import { serverClient } from "@/lib/supabase";
import {
    getFirstImageFromContent,
    getFirstThreeSentences,
    formatPubDateKST,
} from "@/lib/blog";

// 포트폴리오 프로젝트 최대 표시 수
const PORTFOLIO_PROJ_MAX_NUM = 4;
// 블로그 포스트 최대 표시 수
const BLOG_POST_MAX_NUM = 5;

// ── About 미리보기 ────────────────────────────────────────────
interface AboutData {
    name?: string;
    description?: string;
    descriptionSub?: string;
}
let about: AboutData = {};
if (serverClient) {
    const { data } = await serverClient
        .from("about_data")
        .select("data")
        .limit(1)
        .single();
    if (data) about = data.data as AboutData;
}

// ── Portfolio featured items ──────────────────────────────────
interface FeaturedItem {
    slug: string;
    title: string;
    description: string | null;
    tags: string[] | null;
    thumbnail: string | null;
}
let featuredItems: FeaturedItem[] = [];
if (serverClient) {
    const { data } = await serverClient
        .from("portfolio_items")
        .select("slug, title, description, tags, thumbnail")
        .eq("published", true)
        .eq("featured", true)
        .order("order_idx", { ascending: true })
        .limit(PORTFOLIO_PROJ_MAX_NUM);
    if (data) featuredItems = data as FeaturedItem[];
}

// ── Blog 최신 5개 ─────────────────────────────────────────────
interface PostPreview {
    slug: string;
    title: string;
    displayDescription: string;
    pubDateFormatted: string;
    pubDateIso: string;
    category: string | null;
    thumbnailUrl: string | null;
}
let latestPosts: PostPreview[] = [];
if (serverClient) {
    const { data } = await serverClient
        .from("posts")
        .select(
            "slug, title, description, pub_date, category, thumbnail, content"
        )
        .eq("published", true)
        .order("pub_date", { ascending: false })
        .limit(BLOG_POST_MAX_NUM);
    if (data) {
        latestPosts = data.map((p) => {
            const body: string = p.content ?? "";
            const firstImage = getFirstImageFromContent(body);
            return {
                slug: p.slug,
                title: p.title,
                displayDescription:
                    p.description?.trim() ?? getFirstThreeSentences(body),
                pubDateFormatted: formatPubDateKST(new Date(p.pub_date)),
                pubDateIso: new Date(p.pub_date).toISOString(),
                category: p.category?.trim() ?? null,
                thumbnailUrl: p.thumbnail || firstImage || null,
            };
        });
    }
}

const heroName = about.name ?? "FoliumOnline";
const heroDesc =
    about.description ?? "포트폴리오와 기술 블로그가 함께하는 공간입니다.";
const isDev = import.meta.env.DEV;
---

<BaseLayout
    title="FoliumOnline - 포트폴리오 & 기술 블로그"
    description={heroDesc}
>
    <!-- ── Hero ──────────────────────────────────────────────── -->
    <section class="tablet:py-24 mx-auto max-w-4xl py-16 text-center">
        <p
            class="mb-4 text-sm font-semibold tracking-widest text-(--color-accent) uppercase"
        >
            포트폴리오 & 기술 블로그
        </p>
        <h1
            class="tablet:text-6xl mb-4 text-4xl leading-tight font-black text-(--color-foreground)"
        >
            {heroName}
        </h1>
        <p
            class="mx-auto mb-8 max-w-2xl text-lg leading-relaxed text-(--color-muted)"
        >
            {heroDesc}
        </p>
        <div class="flex flex-wrap justify-center gap-3">
            <a
                href="/portfolio"
                class="rounded-lg bg-(--color-accent) px-6 py-3 text-sm font-semibold text-(--color-on-accent) transition-opacity hover:opacity-90"
            >
                Portfolio 보기
            </a>
            <a
                href="/resume"
                class="rounded-lg border border-(--color-border) px-6 py-3 text-sm font-semibold text-(--color-foreground) transition-colors hover:border-(--color-accent) hover:text-(--color-accent)"
            >
                Resume 보기
            </a>
        </div>
    </section>

    <!-- ── About 미리보기 ──────────────────────────────────────── -->
    {
        about.name && (
            <section class="mx-auto max-w-4xl border-t border-(--color-border) py-12">
                <h2 class="mb-6 text-2xl font-bold text-(--color-foreground)">
                    About me
                </h2>
                <div class="tablet:flex-row tablet:items-start tablet:gap-8 flex flex-col gap-4">
                    <div class="flex-1">
                        {about.description && (
                            <p class="mb-3 leading-relaxed text-(--color-foreground)">
                                {about.description}
                            </p>
                        )}
                        {about.descriptionSub && (
                            <p class="text-sm leading-relaxed text-(--color-muted)">
                                {about.descriptionSub}
                            </p>
                        )}
                        <a
                            href="/about"
                            class="mt-4 inline-flex items-center gap-1 text-sm font-medium text-(--color-accent) hover:underline"
                        >
                            소개 전체 보기
                            <svg
                                class="h-4 w-4"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9 5l7 7-7 7"
                                />
                            </svg>
                        </a>
                    </div>
                </div>
            </section>
        )
    }

    <!-- ── Portfolio Featured ─────────────────────────────────── -->
    {
        featuredItems.length > 0 && (
            <section class="mx-auto max-w-4xl border-t border-(--color-border) py-12">
                <div class="mb-6 flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-(--color-foreground)">
                        Portfolio
                    </h2>
                    <a
                        href="/portfolio"
                        class="inline-flex items-center gap-1 text-sm font-medium text-(--color-accent) hover:underline"
                    >
                        전체 보기
                        <svg
                            class="h-4 w-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 5l7 7-7 7"
                            />
                        </svg>
                    </a>
                </div>
                <div class="tablet:grid-cols-2 tablet:gap-6 grid grid-cols-1 gap-4">
                    {featuredItems.map((item) => (
                        <a
                            href={`/portfolio/${item.slug}`}
                            class="group block overflow-hidden rounded-xl border border-(--color-border) bg-(--color-surface-subtle) transition-colors hover:border-(--color-accent)"
                        >
                            {item.thumbnail && (
                                <div class="aspect-video overflow-hidden bg-(--color-border)">
                                    <img
                                        src={item.thumbnail}
                                        alt=""
                                        width={480}
                                        height={270}
                                        loading="lazy"
                                        class="h-full w-full object-cover transition-transform group-hover:scale-105"
                                    />
                                </div>
                            )}
                            <div class="p-5">
                                <h3 class="mb-2 font-semibold text-(--color-foreground) transition-colors group-hover:text-(--color-accent)">
                                    {item.title}
                                </h3>
                                {item.description && (
                                    <p class="mb-3 line-clamp-2 text-sm text-(--color-muted)">
                                        {item.description}
                                    </p>
                                )}
                                {item.tags && item.tags.length > 0 && (
                                    <div class="flex flex-wrap gap-1.5">
                                        {item.tags.slice(0, 4).map((t) => (
                                            <span class="rounded-full bg-(--color-tag-bg) px-2 py-0.5 text-xs text-(--color-tag-fg)">
                                                {t}
                                            </span>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </a>
                    ))}
                </div>
            </section>
        )
    }

    <!-- ── Blog 최신 글 ────────────────────────────────────────── -->
    {
        latestPosts.length > 0 && (
            <section class="mx-auto max-w-4xl border-t border-(--color-border) py-12">
                <div class="mb-6 flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-(--color-foreground)">
                        Blog
                    </h2>
                    <a
                        href="/blog"
                        class="inline-flex items-center gap-1 text-sm font-medium text-(--color-accent) hover:underline"
                    >
                        전체 보기
                        <svg
                            class="h-4 w-4"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 5l7 7-7 7"
                            />
                        </svg>
                    </a>
                </div>

                {/* 최신 2개 — 큰 카드 블록 */}
                <div class="tablet:grid-cols-2 tablet:gap-6 mb-6 grid grid-cols-1 gap-4">
                    {latestPosts.slice(0, 2).map((post) => (
                        <a
                            href={`/blog/${post.slug}`}
                            class="group block overflow-hidden rounded-xl border border-(--color-border) bg-(--color-surface-subtle) transition-colors hover:border-(--color-accent)"
                        >
                            {post.thumbnailUrl && (
                                <div class="aspect-video overflow-hidden bg-(--color-border)">
                                    <img
                                        src={post.thumbnailUrl}
                                        alt=""
                                        width={480}
                                        height={270}
                                        loading="lazy"
                                        class="h-full w-full object-cover transition-transform group-hover:scale-105"
                                    />
                                </div>
                            )}
                            <div class="p-5">
                                {post.category && (
                                    <p class="mb-1 text-xs font-semibold tracking-wider text-(--color-accent) uppercase">
                                        {post.category}
                                    </p>
                                )}
                                <h3 class="mb-2 line-clamp-2 font-semibold text-(--color-foreground) transition-colors group-hover:text-(--color-accent)">
                                    {post.title}
                                </h3>
                                <p class="mb-3 line-clamp-2 text-sm text-(--color-muted)">
                                    {post.displayDescription}
                                </p>
                                <time
                                    datetime={post.pubDateIso}
                                    class="text-xs text-(--color-muted)"
                                >
                                    {post.pubDateFormatted}
                                </time>
                            </div>
                        </a>
                    ))}
                </div>

                {/* 다음 3개 — 컴팩트 리스트 */}
                {latestPosts.length > 2 && (
                    <ul class="divide-y divide-(--color-border) overflow-hidden rounded-xl border border-(--color-border)">
                        {latestPosts.slice(2).map((post) => (
                            <li>
                                <a
                                    href={`/blog/${post.slug}`}
                                    class="group flex items-start gap-4 bg-(--color-surface-subtle) px-5 py-4 transition-colors hover:bg-(--color-surface)"
                                >
                                    <div class="min-w-0 flex-1">
                                        {post.category && (
                                            <span class="mr-2 text-xs font-semibold tracking-wider text-(--color-accent) uppercase">
                                                {post.category}
                                            </span>
                                        )}
                                        <span class="text-sm font-medium text-(--color-foreground) transition-colors group-hover:text-(--color-accent)">
                                            {post.title}
                                        </span>
                                    </div>
                                    <time
                                        datetime={post.pubDateIso}
                                        class="mt-0.5 shrink-0 text-xs text-(--color-muted)"
                                    >
                                        {post.pubDateFormatted}
                                    </time>
                                </a>
                            </li>
                        ))}
                    </ul>
                )}
            </section>
        )
    }

    <!-- ── Dev 도구 (dev 환경 전용) ───────────────────────────── -->
    {
        isDev && (
            <section class="mx-auto mt-4 mb-8 max-w-4xl rounded-xl border border-dashed border-(--color-border) bg-(--color-surface-subtle) p-4">
                <p class="mb-3 text-xs font-medium tracking-wider text-(--color-muted) uppercase">
                    개발 도구
                </p>
                <div class="flex flex-wrap gap-3">
                    <a
                        href="/admin"
                        class="inline-flex items-center gap-2 rounded-lg border border-(--color-border) bg-(--color-surface) px-4 py-2 text-sm font-medium text-(--color-foreground) transition-opacity hover:opacity-90"
                    >
                        Admin
                    </a>
                </div>
            </section>
        )
    }
</BaseLayout>
