---
/**
 * 블로그 포스트 상세 페이지
 * 빌드 타임에 Supabase posts, tags 테이블에서 fetch한다.
 * 마크다운 본문은 Markdoc + Shiki 파이프라인으로 HTML 변환한다.
 */
import BaseLayout from "@/layouts/BaseLayout.astro";
import { serverClient } from "@/lib/supabase";
import { formatPubDateKST } from "@/lib/blog";
import { renderMarkdown } from "@/lib/markdown";
import { extractTocFromHtml } from "@/lib/toc";
import TableOfContents from "@/components/TableOfContents";

export async function getStaticPaths() {
    if (!serverClient) return [];
    const { data: posts } = await serverClient
        .from("posts")
        .select("slug")
        .eq("published", true);
    if (!posts) return [];
    return posts.map((p) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
if (!slug || !serverClient) return Astro.redirect("/blog");

const { data: post } = await serverClient
    .from("posts")
    .select("*")
    .eq("slug", slug)
    .single();

if (!post) return Astro.redirect("/blog");

// 태그 slug → 표시명, 색상 매핑 (Supabase tags 테이블)
let slugToTagName = new Map<string, string>();
let slugToTagColor = new Map<string, string>();
if (serverClient) {
    const { data: tagsData } = await serverClient
        .from("tags")
        .select("slug, name, color");
    if (tagsData) {
        slugToTagName = new Map(tagsData.map((t) => [t.slug, t.name]));
        slugToTagColor = new Map(
            tagsData
                .filter((t) => t.color?.trim())
                .map((t) => [t.slug, t.color!.trim()])
        );
    }
}

// 마크다운 → HTML 변환 (Markdoc + Shiki, 빌드 타임)
const contentHtml = await renderMarkdown(post.content ?? "");
const tocEntries = extractTocFromHtml(contentHtml);

const category: string = post.category?.trim() ?? "";
const tagSlugs: string[] = post.tags ?? [];
const tagDisplay = tagSlugs.filter(Boolean).map((s) => ({
    slug: s,
    name: slugToTagName.get(s) ?? s,
    color: slugToTagColor.get(s),
}));
const pubDate = new Date(post.pub_date);
const pageTitle =
    post.meta_title ||
    (category
        ? `${category} | ${post.title} - FoliumOnline`
        : `${post.title} - FoliumOnline`);
const pageDesc = post.meta_description || post.description || "";
const pageImage = post.og_image || post.thumbnail || "";
---

<BaseLayout title={pageTitle} description={pageDesc} image={pageImage}>
    <div class="mx-auto flex max-w-5xl gap-12">
        <article class="max-w-3xl min-w-0 flex-1">
            <header class="mb-6">
                <h1
                    class="mb-2 flex flex-wrap items-baseline gap-x-2 gap-y-1 text-4xl font-bold"
                >
                    {
                        category ? (
                            <>
                                <span class="text-4xl font-bold text-(--color-highlight)">
                                    {category}
                                </span>
                                <span class="text-(--color-muted)" aria-hidden>
                                    |
                                </span>
                            </>
                        ) : null
                    }
                    <span>{post.title}</span>
                </h1>
                {
                    post.description && (
                        <p class="text-lg text-(--color-muted)">
                            {post.description}
                        </p>
                    )
                }
                <time
                    class="mt-2 block text-sm text-(--color-muted)"
                    datetime={pubDate.toISOString()}
                >
                    {formatPubDateKST(pubDate)}
                </time>
                {
                    tagDisplay.length > 0 && (
                        <div
                            class="mt-4 flex flex-wrap gap-2"
                            aria-label="태그"
                        >
                            {tagDisplay.map((t) => (
                                <a
                                    href={`/blog?tag=${encodeURIComponent(t.slug)}`}
                                    class="rounded-full bg-(--color-tag-bg) px-2 py-1 text-xs text-(--color-tag-fg) transition-opacity hover:opacity-85"
                                    style={
                                        t.color
                                            ? {
                                                  backgroundColor: t.color,
                                                  color: "#fff",
                                              }
                                            : undefined
                                    }
                                >
                                    {t.name}
                                </a>
                            ))}
                        </div>
                    )
                }
            </header>
            <div
                class="post-content prose dark:prose-invert max-w-none"
                data-content="true"
                set:html={contentHtml}
            />
        </article>
        <TableOfContents client:visible entries={tocEntries} />
    </div>
</BaseLayout>

<script>
    import {
        renderMermaidBlocks,
        rerenderMermaidOnThemeChange,
    } from "@/lib/mermaid-render";

    const run = () => renderMermaidBlocks(".post-content", "blog post");
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", run);
    } else {
        run();
    }
    window.addEventListener("themechange", () =>
        rerenderMermaidOnThemeChange("blog post")
    );
</script>
