---
/**
 * FoliumTable - Card-style table with rounded corners, shadow, and clear hierarchy.
 * Color args accept Tailwind color names (e.g. "red-400", "green-200").
 * Light/dark variants for header and row backgrounds; text contrast auto-adjusted.
 */
import { tailwindToHex, isLightBackground } from "@/lib/tailwind-colors";

interface Props {
    columns: string | string[];
    rows: string | string[][];
    columnHeadColors?: string | string[];
    columnHeadColorsDark?: string | string[];
    rowColors?: string | string[];
    rowColorsDark?: string | string[];
}

function parseStringArray(
    val: string | string[] | undefined
): string[] | undefined {
    if (val === undefined) return undefined;
    return typeof val === "string" ? JSON.parse(val) : val;
}

function parseRowArray(
    val: string | string[][] | undefined
): string[][] | undefined {
    if (val === undefined) return undefined;
    return typeof val === "string" ? JSON.parse(val) : val;
}

const {
    columns,
    rows,
    columnHeadColors,
    columnHeadColorsDark,
    rowColors,
    rowColorsDark,
} = Astro.props;

/** 최대 이 길이 이하인 셀은 한 줄로 표시(줄바꿈 없음) */
const NOWRAP_MAX_LEN = 15;

function isShortCell(text: string): boolean {
    return text.length < NOWRAP_MAX_LEN + 1;
}

const headers: string[] = parseStringArray(columns) ?? [];
const dataRows: string[][] = parseRowArray(rows) ?? [];
const headColors = parseStringArray(columnHeadColors);
const headColorsDark = parseStringArray(columnHeadColorsDark);
const bodyColors = parseStringArray(rowColors);
const bodyColorsDark = parseStringArray(rowColorsDark);

function getTextColor(tailwindName: string, isDark: boolean): string {
    const light = isLightBackground(tailwindName);
    if (isDark) {
        return light ? "var(--color-foreground)" : "rgba(255,255,255,0.95)";
    }
    return light ? "var(--color-foreground)" : "rgba(255,255,255,0.95)";
}
---

<div class="folium-table-wrapper">
    <table
        class={`folium-table ${
            headColors?.length || bodyColors?.length ? "has-col-colors" : ""
        }`}
    >
        <thead>
            <tr>
                {
                    headers.map((h, i) => {
                        const twLight = headColors?.[i];
                        const twDark = headColorsDark?.[i];
                        const bgLight = twLight
                            ? tailwindToHex(twLight)
                            : undefined;
                        const bgDark = twDark
                            ? tailwindToHex(twDark)
                            : undefined;
                        const textLight = twLight
                            ? getTextColor(twLight, false)
                            : undefined;
                        const textDark = twDark
                            ? getTextColor(twDark, true)
                            : twLight
                              ? getTextColor(twLight, true)
                              : undefined;
                        const headShort = isShortCell(h);
                        const headClass =
                            (twLight || twDark ? "pt-head-col " : "") +
                            (headShort ? "ft-nowrap" : "");
                        return (
                            <th
                                class={headClass.trim()}
                                style={
                                    bgLight
                                        ? ({
                                              "--pt-bg": bgLight,
                                              "--pt-text": textLight,
                                          } as Record<string, string>)
                                        : undefined
                                }
                                data-pt-head-idx={i}
                                data-pt-bg-dark={bgDark}
                                data-pt-text-dark={textDark}
                            >
                                {h}
                            </th>
                        );
                    })
                }
            </tr>
        </thead>
        <tbody>
            {
                dataRows.map((row) => (
                    <tr>
                        {row.map((cell, i) => {
                            const twLight = bodyColors?.[i];
                            const twDark = bodyColorsDark?.[i];
                            const bgLight = twLight
                                ? tailwindToHex(twLight)
                                : undefined;
                            const bgDark = twDark
                                ? tailwindToHex(twDark)
                                : undefined;
                            const textLight = twLight
                                ? getTextColor(twLight, false)
                                : undefined;
                            const textDark = twDark
                                ? getTextColor(twDark, true)
                                : twLight
                                  ? getTextColor(twLight, true)
                                  : undefined;
                            const cellText = cell || "—";
                            const cellShort = isShortCell(cellText);
                            const cellClass =
                                (twLight || twDark ? "pt-body-col " : "") +
                                (cellShort ? "ft-nowrap" : "");
                            return (
                                <td
                                    class={cellClass.trim()}
                                    style={
                                        bgLight
                                            ? ({
                                                  "--pt-bg": bgLight,
                                                  "--pt-text": textLight,
                                              } as Record<string, string>)
                                            : undefined
                                    }
                                    data-pt-body-idx={i}
                                    data-pt-bg-dark={bgDark}
                                    data-pt-text-dark={textDark}
                                >
                                    {cellText}
                                </td>
                            );
                        })}
                    </tr>
                ))
            }
        </tbody>
    </table>
</div>
